{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}
{% block head %}
    <link rel="stylesheet"
          href="{% static 'logistics/css/create_conference.css' %}">
{% endblock head %}
{% block content %}
    <div class="container py-4">
        <h1 class="mb-4">Criar Conferência</h1>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {% if form.non_field_errors %}<div class="alert alert-danger">{{ form.non_field_errors }}</div>{% endif %}
            <!-- Forma de criação -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Forma de criação</h5>
                    {% for radio in form.creation_mode %}
                        <div class="form-check">
                            {{ radio.tag }}
                            <label class="form-check-label" for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
                        </div>
                    {% endfor %}
                </div>
            </div>
            <!-- VIA CT-e -->
            <div id="cte-section" class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Importação por CT-e</h5>
                    <div class="mb-3">
                        <label class="form-label" for="{{ form.cte_files.id_for_label }}">Arquivos CT-e</label>
                        {{ form.cte_files|add_class:"form-control" }}
                        {% if form.cte_files.errors %}<div class="invalid-feedback d-block">{{ form.cte_files.errors }}</div>{% endif %}
                        <div class="form-text">Permite importar múltiplos arquivos.</div>
                    </div>
                </div>
            </div>
            <!-- VIA NF-e -->
            <div id="nfe-section" class="card mb-4" style="display:none;">
                <div class="card-body">
                    <h5 class="card-title">Importação por NF-e</h5>
                    <div class="mb-3">
                        <label class="form-label" for="{{ form.nfe_files.id_for_label }}">Arquivos NF-e</label>
                        {{ form.nfe_files|add_class:"form-control" }}
                        {% if form.nfe_files.errors %}<div class="invalid-feedback d-block">{{ form.nfe_files.errors }}</div>{% endif %}
                        <div class="form-text">Permite importar múltiplos arquivos.</div>
                    </div>
                </div>
            </div>
            <!-- CHAVE DE ACESSO -->
            <div id="access-key-section" class="card mb-4" style="display:none;">
                <div class="card-body">
                    <h5 class="card-title">Via chave de acesso</h5>
                    <label class="form-label">Informe a chave de acesso da nota fiscal</label>
                    <div id="access-key-container" class="form-control d-flex flex-wrap gap-2">
                        <input type="text"
                               id="access-key-input"
                               class="border-0 flex-grow-1"
                               placeholder="Leia a chave e pressione Enter" />
                    </div>
                    <!-- Campo REAL enviado ao Django -->
                    <input type="hidden" name="access_keys" id="access-keys-hidden">
                    <div class="form-text">Permite informar múltiplas chaves de acesso.</div>
                    {% if form.access_key.errors %}<div class="invalid-feedback d-block">{{ form.access_key.errors }}</div>{% endif %}
                </div>
            </div>
            <!-- Entidades -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Entidades</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="{{ form.supplier.id_for_label }}">Fornecedor</label>
                            {{ form.supplier|add_class:"form-select" }}
                            {% if form.supplier.errors %}<div class="invalid-feedback d-block">{{ form.supplier.errors }}</div>{% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="{{ form.carrier.id_for_label }}">Transportadora</label>
                            {{ form.carrier|add_class:"form-select" }}
                            {% if form.carrier.errors %}<div class="invalid-feedback d-block">{{ form.carrier.errors }}</div>{% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="{{ form.next_destiny.id_for_label }}">Próximo Destino</label>
                            {{ form.next_destiny|add_class:"form-select" }}
                            {% if form.next_destiny.errors %}<div class="invalid-feedback d-block">{{ form.next_destiny.errors }}</div>{% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="{{ form.client.id_for_label }}">Destino final</label>
                            {{ form.client|add_class:"form-select" }}
                            {% if form.client.errors %}<div class="invalid-feedback d-block">{{ form.client.errors }}</div>{% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <!-- Ações -->
            <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-primary">Criar Conferência</button>
            </div>
        </form>
    </div>
    <script>
document.addEventListener("DOMContentLoaded", function () {

    // Inicializa Select2 em todos os selects marcados
    $('.select2').select2({
        width: '100%',
        theme: 'bootstrap-5',
        placeholder: 'Selecione uma opção',
        allowClear: true
    });

    const cteSection = document.getElementById("cte-section");
    const nfeSection = document.getElementById("nfe-section");
    const accessKeySection = document.getElementById("access-key-section");

    const radios = document.querySelectorAll("input[name='creation_mode']");
    const cteInput = document.getElementById("{{ form.cte_files.id_for_label }}");
    const nfeInput = document.getElementById("{{ form.nfe_files.id_for_label }}");
    const keyInput = document.getElementById("access-key-input");
    const container = document.getElementById("access-key-container");
    const hiddenInput = document.getElementById("access-keys-hidden");

    let accessKeys = [];

    function syncHiddenField() {
        hiddenInput.value = JSON.stringify(accessKeys);
    }

    function isValidAccessKey(value) {
        return /^\d{44}$/.test(value); // chave NF-e tem 44 dígitos
    }

    function addAccessKey(value) {
        if (!isValidAccessKey(value)) return;
        if (accessKeys.includes(value)) return;

        accessKeys.push(value);
        syncHiddenField();

        const chip = document.createElement("div");
        chip.className = "access-key-chip";
        chip.innerHTML = `
            <span>${value}</span>
            <button type="button">×</button>
        `;

        chip.querySelector("button").addEventListener("click", () => {
            accessKeys = accessKeys.filter(k => k !== value);
            syncHiddenField();
            chip.remove();
        });

        container.insertBefore(chip, keyInput);
    }

    keyInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
            e.preventDefault();
            const value = keyInput.value.trim();
            addAccessKey(value);
            keyInput.value = "";
        }
    });

    container.addEventListener("click", () => keyInput.focus());

    function toggleSections() {
        const mode = document.querySelector("input[name='creation_mode']:checked").value;

        if (mode === "cte") {
            cteSection.style.display = "block";
            nfeSection.style.display = "none";
            accessKeySection.style.display = "none";

            cteInput.required = true;
            nfeInput.required = false;
            accessKeyInput.required = false;
        } else if (mode === "nfe") {
            cteSection.style.display = "none";
            nfeSection.style.display = "block";
            accessKeySection.style.display = "none";

            cteInput.required = false;
            nfeInput.required = true;
            accessKeyInput.required = false;
        } else if (mode === "access_key") {
            cteSection.style.display = "none";
            nfeSection.style.display = "none";
            accessKeySection.style.display = "block";

            cteInput.required = false;
            nfeInput.required = false;
            accessKeyInput.required = true;
        }
    }

    radios.forEach(radio => radio.addEventListener("change", toggleSections));
    toggleSections();
});
    </script>
{% endblock %}
